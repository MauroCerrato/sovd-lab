# SPDX-License-Identifier: Apache-2.0
version: '3.9'

services:
  # 1. MOCK SERVER (Python)
  mock-sovd:
    build: ./services/mock-sovd
    ports:
      - "8080:8080"
    networks:
      - sovd-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/entities"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 2. LEGACY ADAPTER (Python/Simulated)
  # ATTENZIONE: Percorso corretto da ./services a ./examples
  obd2-sovd-sim:
    build: ./examples/obd2-sovd-sim 
    ports:
      - "8083:8080"  # Interna 8080, Esterna 8083
    networks:
      - sovd-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/vehicle-001/api/vin"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 3. API GATEWAY (Python)
  gateway:
    build: ./services/gateway
    environment:
      - TARGET_BASE=http://mock-sovd:8080
      # CORREZIONE: Usa la porta interna (8080) per parlare tra container
      - BRIDGE_BASE=http://obd2-sovd-sim:8080 
    ports:
      - "8081:8081"
    depends_on:
      mock-sovd:
        condition: service_healthy
      obd2-sovd-sim:
        condition: service_healthy
    networks:
      - sovd-net

  # 4. CAPABILITIES SERVICE (Go)
  go-capabilities:
    build:
      context: ./services/go-capabilities
    image: maurocerrato/go-capabilities:dev
    container_name: go-capabilities
    environment:
      - PORT=8085
    ports:
      - "8085:8085"
    networks:       # Aggiunta rete mancante
      - sovd-net
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8085/healthz"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # 5. SOTIF SENTINEL (Kotlin - NEW HAAD LAYER)
  kotlin-events:
    build:
      context: ./services/kotlin-events
      dockerfile: Dockerfile
    container_name: sovd-lab-kotlin-events
    ports:
      - "8082:8082"
    environment:
      - LOG_LEVEL=INFO
    networks:
      - sovd-net

# Unica rete condivisa per semplificare il Lab
networks:
  sovd-net:
    driver: bridge
    